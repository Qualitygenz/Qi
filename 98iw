local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")

local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "Quality x",
    Icon = "rbxassetid://138614699274576",
    Author = "Hello, I'm Txr, I'm cool.",
    Folder = "MySuperHub",
    Size = UDim2.fromOffset(580, 460),
    MinSize = Vector2.new(560, 350),
    MaxSize = Vector2.new(850, 560),
    Transparent = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 200,
    BackgroundImageTransparency = 0.42,
    HideSearchBar = true,
    ScrollBarEnabled = false,
    User = {
        Enabled = true,
        Anonymous = false,
        Name = LocalPlayer.Name,
        Image = "rbxthumb://type=AvatarHeadShot&id=" .. LocalPlayer.UserId,
        Callback = function() end,
    },
})

Window:EditOpenButton({ Enabled = false })

local ScreenGui = Instance.new("ScreenGui")
local ToggleBtn = Instance.new("ImageButton")

ScreenGui.Name = "WindUI_Toggle"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = CoreGui

ToggleBtn.Size = UDim2.new(0, 50, 0, 50)
ToggleBtn.Position = UDim2.new(0, 20, 0.5, -25)
ToggleBtn.BackgroundTransparency = 1
ToggleBtn.Image = "rbxassetid://138614699274576" 
ToggleBtn.Active = true
ToggleBtn.Draggable = true
ToggleBtn.Parent = ScreenGui

local opened = true

local function toggle()
    opened = not opened
    if Window.UI then
        Window.UI.Enabled = opened
    else
        Window:Toggle()
    end
end

ToggleBtn.MouseButton1Click:Connect(function()
    ToggleBtn:TweenSize(
        UDim2.new(0, 56, 0, 56),
        Enum.EasingDirection.Out,
        Enum.EasingStyle.Quad,
        0.12,
        true,
        function()
            ToggleBtn:TweenSize(
                UDim2.new(0, 50, 0, 50),
                Enum.EasingDirection.Out,
                Enum.EasingStyle.Quad,
                0.12,
                true
            )
        end
    )
    toggle()
end)

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.T then
        toggle()
    end
end)


if not LocalPlayer.Character then
LocalPlayer.CharacterAdded:Wait()
end


local CombatTab   = Window:Tab({Title = "Combat",   Icon = "crosshair"})

--// ================= STATE (เปิดตลอด) =================
local SilentAimEnabled = true      -- เปิดตลอด
local TracerEnabled   = true       -- เปิดตลอด
local ShowFOV         = false       -- คุมด้วย UI
local FOV             = 150        -- คุมด้วย Slider

--// ================= GUN LIST (ลิสต์ล้วน) =================
local GunNames = {
	"P226","MP5","M24","Draco","Glock","Sawnoff","Uzi","G3","C9",
	"Hunting Rifle","Anaconda","AK47","Remington","Double Barrel"
}

--// ================= FOV CIRCLE =================
local fovCircle = Drawing.new("Circle")
fovCircle.Color = Color3.fromRGB(255,255,255)
fovCircle.Thickness = 2
fovCircle.NumSides = 100
fovCircle.Filled = false
fovCircle.Visible = ShowFOV
fovCircle.Radius = FOV

--// ================= TRACER =================
local tracerLine = Drawing.new("Line")
tracerLine.Color = Color3.fromRGB(255,0,0)
tracerLine.Thickness = 2
tracerLine.Visible = false

--// ================= TARGET FINDER =================
local function GetClosestTarget()
	local closest, shortest = nil, math.huge
	local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)

	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer
			and not plr:GetAttribute("SilentAimIgnore")
			and plr.Character
			and plr.Character:FindFirstChild("Head") then

			local pos, onScreen = Camera:WorldToViewportPoint(plr.Character.Head.Position)
			if onScreen then
				local dist = (Vector2.new(pos.X, pos.Y) - center).Magnitude
				if dist < FOV and dist < shortest then
					shortest = dist
					closest = plr
				end
			end
		end
	end

	return closest
end

--// ================= GUN CHECK =================
local function IsHoldingAllowedGun(args)
	-- เช็คจาก remote args ก่อน
	local ok, weapon = pcall(function()
		return args[3]
	end)

	if ok and typeof(weapon) == "Instance" and weapon.Name
		and table.find(GunNames, weapon.Name) then
		return true
	end

	-- เช็คจากตัวละคร
	if LocalPlayer.Character then
		for _, v in pairs(LocalPlayer.Character:GetChildren()) do
			if (v:IsA("Tool") or v:IsA("Model"))
				and v.Name
				and table.find(GunNames, v.Name) then
				return true
			end
		end
	end

	return false
end

--// ================= HOOK REMOTE =================
local send = ReplicatedStorage.Remotes.Send
local oldFire
oldFire = hookfunction(send.FireServer, function(self, ...)
	local args = {...}

	if SilentAimEnabled and IsHoldingAllowedGun(args) then
		local target = GetClosestTarget()
		if target and target.Character and target.Character:FindFirstChild("Head") then
			local head = target.Character.Head
			args[4] = CFrame.new(math.huge, math.huge, math.huge)
			args[5] = {
				[1] = {
					[1] = {
						Instance = head,
						Position = head.Position
					}
				}
			}
		end
	end

	return oldFire(self, unpack(args))
end)

--// ================= RENDER LOOP =================
RunService.RenderStepped:Connect(function()
	fovCircle.Position = Vector2.new(
		Camera.ViewportSize.X/2,
		Camera.ViewportSize.Y/2
	)
	fovCircle.Radius = FOV
	fovCircle.Visible = ShowFOV

	local target = GetClosestTarget()
	if TracerEnabled
		and target
		and target.Character
		and target.Character:FindFirstChild("Head")
		and LocalPlayer.Character
		and LocalPlayer.Character:FindFirstChild("Head") then

		local tPos, tOn = Camera:WorldToViewportPoint(target.Character.Head.Position)
		local mPos, mOn = Camera:WorldToViewportPoint(LocalPlayer.Character.Head.Position)

		if tOn and mOn then
			tracerLine.From = Vector2.new(mPos.X, mPos.Y)
			tracerLine.To   = Vector2.new(tPos.X, tPos.Y)
			tracerLine.Visible = true
			return
		end
	end

	tracerLine.Visible = false
end)

--// ================= UI (เฉพาะ Show FOV + Slider) =================
do
	CombatTab:Toggle({
		Title = "Show FOV",
		Default = ShowFOV,
		Callback = function(v)
			ShowFOV = v
		end
	})

	CombatTab:Slider({
		Title = "FOV Size",
		Step = 1,
		Value = {
			Min = 50,
			Max = 500,
			Default = FOV
		},
		Callback = function(v)
			FOV = v
		end
	})
end

--// ===== Get Player Names =====
local function GetPlayerNames()
	local t = {}
	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer then
			table.insert(t, plr.Name)
		end
	end
	return t
end

--// ===== Save Friend Dropdown (SilentAim Ignore) =====
CombatTab:Dropdown({
	Title = "Save Friend",
	Values = GetPlayerNames(),
	Multi = true,
	Default = {},
	Callback = function(selected)
		-- reset ทุกคนก่อน
		for _, plr in pairs(Players:GetPlayers()) do
			plr:SetAttribute("SilentAimIgnore", false)
		end

		-- ตั้งค่าเฉพาะชื่อที่เลือก
		for _, name in pairs(selected) do
			local plr = Players:FindFirstChild(name)
			if plr then
				plr:SetAttribute("SilentAimIgnore", true)
			end
		end
	end
})
